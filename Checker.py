import streamlit as st
from shapely.geometry import Point, Polygon
import folium
from streamlit_folium import st_folium
from streamlit_js_eval import get_geolocation
import re

# ----------------------------
# 1) Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø©
# ----------------------------
st.set_page_config(page_title="Urban Cordon Checker", page_icon="ğŸŒ", layout="wide")

# ----------------------------
# 2) Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª (CSS)
# ----------------------------
hide_streamlit_style = """
<style>
#MainMenu {visibility: hidden;}
footer {visibility: hidden;}
header {visibility: hidden;}
.stApp > header {display: none;}
</style>
"""
st.markdown(hide_streamlit_style, unsafe_allow_html=True)

# ----------------------------
# 3) ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
# ----------------------------
if "search_result" not in st.session_state:
    st.session_state.search_result = None
if "input_coords" not in st.session_state:
    st.session_state.input_coords = ""

# ----------------------------
# 4) Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù†Ù‚Ø§Ø· Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø­ÙŠØ²)
# NOTE:
# - Folium ÙŠØ³ØªØ®Ø¯Ù… (Lat, Lon)
# - Shapely ÙŠØ­ØªØ§Ø¬ (Lon, Lat)
# ----------------------------
BOUNDARY_POINTS = [
    (30.722009, 31.295623), (30.721122, 31.295481), (30.721285, 31.294259), (30.722031, 31.294366), (30.725045, 31.294755),
    (30.730050, 31.302733), (30.730125, 31.302278), (30.729349, 31.302003), (30.729198, 31.302683), (30.729641, 31.302797),
    (30.729435, 31.303796), (30.727487, 31.303334), (30.727292, 31.304539), (30.726293, 31.304657), (30.726367, 31.304013),
    (30.725509, 31.303733), (30.725668, 31.303050), (30.725328, 31.302976), (30.725102, 31.302035), (30.724626, 31.301933),
    (30.724686, 31.300365), (30.723999, 31.300409), (30.724035, 31.299283), (30.724191, 31.299282), (30.724183, 31.299604),
    (30.724561, 31.299566), (30.724542, 31.298039), (30.724166, 31.298057), (30.724177, 31.298978), (30.723874, 31.298982),
    (30.723883, 31.298796), (30.723563, 31.298763), (30.723571, 31.299340), (30.723351, 31.299368), (30.723354, 31.299624),
    (30.723106, 31.299629), (30.723083, 31.299289), (30.722603, 31.299287), (30.722602, 31.299040), (30.722476, 31.298887),
    (30.722474, 31.298885), (30.723228, 31.298330), (30.723236, 31.298163), (30.723105, 31.298165), (30.723102, 31.297909),
    (30.722863, 31.297913), (30.722820, 31.298446), (30.722298, 31.298443), (30.722293, 31.296397), (30.724224, 31.296490),
    (30.724249, 31.295636), (30.723865, 31.295652), (30.723869, 31.295506), (30.723698, 31.295505), (30.723700, 31.295325),
    (30.723546, 31.295320), (30.723553, 31.295189), (30.723513, 31.295189), (30.723424, 31.295068), (30.723430, 31.294069),
    (30.722907, 31.294052), (30.722870, 31.295608), (30.722565, 31.295599), (30.722601, 31.295016), (30.722308, 31.294998),
    (30.722413, 31.293531), (30.722103, 31.293463), (30.722123, 31.293295), (30.722468, 31.293347), (30.722546, 31.292812),
    (30.722917, 31.292887), (30.722943, 31.292311), (30.722508, 31.292233), (30.722609, 31.291585), (30.722487, 31.291574),
    (30.722551, 31.291134), (30.722271, 31.290978), (30.722376, 31.290487), (30.723197, 31.290470), (30.723447, 31.289850),
    (30.722869, 31.289696), (30.722908, 31.289504), (30.723129, 31.289564), (30.723334, 31.288885), (30.722683, 31.288752),
    (30.722639, 31.288950), (30.722493, 31.288907), (30.722508, 31.288817), (30.722267, 31.288766), (30.722300, 31.288589),
    (30.721931, 31.288531), (30.721987, 31.288171), (30.722862, 31.287790), (30.722983, 31.287686), (30.723240, 31.287739),
    (30.723145, 31.287891), (30.724054, 31.288657), (30.724014, 31.288809), (30.723727, 31.288738), (30.723584, 31.289331),
    (30.723976, 31.289488), (30.724065, 31.289078), (30.724422, 31.289217), (30.724606, 31.287618), (30.725379, 31.287741),
    (30.725432, 31.287241), (30.726149, 31.287339), (30.726072, 31.286229), (30.726688, 31.288502), (30.726883, 31.286281),
    (30.726529, 31.286324), (30.726393, 31.285772), (30.726885, 31.285764), (30.726763, 31.285263), (30.725981, 31.285181),
    (30.726013, 31.284693), (30.726629, 31.284729), (30.726296, 31.283332), (30.727404, 31.283527), (30.727628, 31.282346),
    (30.727934, 31.282098), (30.727906, 31.282351), (30.728364, 31.282331), (30.728379, 31.282563), (30.728533, 31.282559),
    (30.728550, 31.282847), (30.728771, 31.282858), (30.728783, 31.283372), (30.728867, 31.283370), (30.728894, 31.283940),
    (30.729369, 31.283918), (30.729388, 31.284299), (30.729571, 31.284288), (30.729904, 31.285527), (30.730149, 31.285504),
    (30.730166, 31.285871), (30.730870, 31.285854), (30.730911, 31.286129), (30.731057, 31.286175), (30.731075, 31.286738),
    (30.731296, 31.286725), (30.731301, 31.286861), (30.731551, 31.286875), (30.731618, 31.286145), (30.732257, 31.286211),
    (30.732213, 31.286628), (30.732463, 31.286675), (30.733320, 31.287117), (30.733914, 31.287269), (30.733991, 31.286705),
    (30.734372, 31.286789), (30.734334, 31.287032), (30.735238, 31.287192), (30.735163, 31.287714), (30.735515, 31.287807),
    (30.735485, 31.287994), (30.735682, 31.288038), (30.736004, 31.288855), (30.735767, 31.288963), (30.736112, 31.290061),
    (30.736201, 31.290607), (30.736611, 31.290530), (30.736718, 31.292075), (30.737504, 31.292097), (30.737359, 31.293014),
    (30.737856, 31.293283), (30.737787, 31.294242), (30.737386, 31.294167), (30.736955, 31.295531), (30.736568, 31.295382),
    (30.736186, 31.296724), (30.735956, 31.296656), (30.735666, 31.297535), (30.735786, 31.297608), (30.735754, 31.297701),
    (30.736233, 31.297994), (30.735298, 31.300357), (30.735131, 31.300549), (30.735560, 31.300958), (30.735970, 31.301115),
    (30.735685, 31.302161), (30.735944, 31.302214), (30.735818, 31.302683), (30.735475, 31.301738), (30.734499, 31.301261),
    (30.734008, 31.302902), (30.734462, 31.303135), (30.734278, 31.303673), (30.734143, 31.303502), (30.734085, 31.303215),
    (30.733325, 31.302837), (30.733228, 31.303085), (30.733124, 31.303040), (30.732857, 31.304064), (30.732406, 31.303793),
    (30.732351, 31.304903), (30.731808, 31.304799), (30.731905, 31.304481), (30.730897, 31.304118), (30.730894, 31.304281),
    (30.731161, 31.304519), (30.731154, 31.303862), (30.730056, 31.303467), (30.730106, 31.303235), (30.729515, 31.303288),
    (30.722009, 31.295623)
]

# ----------------------------
# 5) ØªØ­ÙˆÙŠÙ„ DMS -> Decimal
# ----------------------------
def convert_dms_to_decimal(dms_string: str):
    """
    Ù…Ø«Ø§Ù„:
    30Â°43'12.1"N 31Â°17'04.2"E
    """
    try:
        parts = re.findall(r"(\d+)[Â°](\d+)['](\d+\.?\d*)[\"]([NSEW])", dms_string)
        decimals = []
        for deg, min_, sec, direction in parts:
            deg = float(deg)
            min_ = float(min_)
            sec = float(sec)
            val = deg + (min_ / 60) + (sec / 3600)
            if direction in ["S", "W"]:
                val = -val
            decimals.append(val)

        if len(decimals) == 2:
            return decimals[0], decimals[1]  # lat, lon
        return None
    except:
        return None

def parse_latlon(user_input: str):
    """ÙŠØ¯Ø¹Ù… decimal Ø£Ùˆ DMS"""
    if not user_input:
        return None

    # decimal
    try:
        clean = user_input.replace(",", " ").split()
        if len(clean) >= 2:
            lat = float(clean[0])
            lon = float(clean[1])
            return lat, lon
    except:
        pass

    # dms
    dms = convert_dms_to_decimal(user_input)
    if dms:
        return dms

    return None

# ----------------------------
# 6) ØªØ¬Ù‡ÙŠØ² Ù…Ø¶Ù„Ø¹ÙŠÙ† (Ø¨Ø¯ÙˆÙ† unary_union)
# ----------------------------
SUB_POINTS = BOUNDARY_POINTS[:4]   # Ø£ÙˆÙ„ 4 Ù†Ù‚Ø§Ø· (Ø¬Ø²Ø¡ Ù…Ù†ÙØµÙ„)
MAIN_POINTS = BOUNDARY_POINTS[4:]  # Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· (Ø§Ù„Ø­ÙŠØ² Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)

def close_ring(points):
    # Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø¶Ù„Ø¹ Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø£ÙˆÙ„ Ù†Ù‚Ø·Ø© ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
    if points and points[0] != points[-1]:
        return points + [points[0]]
    return points

SUB_POINTS = close_ring(SUB_POINTS)
MAIN_POINTS = close_ring(MAIN_POINTS)

# Shapely (Lon, Lat)
sub_poly = Polygon([(lon, lat) for lat, lon in SUB_POINTS])
main_poly = Polygon([(lon, lat) for lat, lon in MAIN_POINTS])

# ----------------------------
# 7) ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
# ----------------------------
st.title("ğŸŒ ÙƒØ´Ù Ø§Ù„Ø­ÙŠØ² Ø§Ù„Ø¹Ù…Ø±Ø§Ù†ÙŠ")
st.caption("ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£Ø±Ø¶ Ø¯Ø§Ø®Ù„/Ø®Ø§Ø±Ø¬ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø­ÙŠØ² Ø§Ù„Ø¹Ù…Ø±Ø§Ù†ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… GPS Ø£Ùˆ Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ.")

st.write("---")
col1, col2 = st.columns([1, 1.6], vertical_alignment="top")

# ---- (A) Ø¥Ø¯Ø®Ø§Ù„ ----
with col1:
    st.subheader("ğŸ“ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…ÙˆÙ‚Ø¹")

    st.markdown("""
        <div style="direction: rtl; text-align: center; border: 2px solid #FF4B4B; padding: 14px; border-radius: 12px; margin-bottom: 12px; background-color: #f9f9f9;">
            <h4 style="margin: 0; color: #31333F;">Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ (GPS)</h4>
        </div>
    """, unsafe_allow_html=True)

    try:
        loc = get_geolocation(component_key="get_loc")
        if loc:
            current_lat = loc["coords"]["latitude"]
            current_lon = loc["coords"]["longitude"]
            st.session_state.input_coords = f"{current_lat}, {current_lon}"
            st.success(f"ğŸ“ ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹: {current_lat:.5f}, {current_lon:.5f}")
        else:
            st.info("Ø§Ø³Ù…Ø­ Ù„Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„Ù…ØªØµÙØ­/Ø§Ù„Ù‡Ø§ØªÙ Ø«Ù… Ø­Ø¯Ù‘Ø« Ø§Ù„ØµÙØ­Ø©.")
    except Exception:
        st.warning("âš ï¸ ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ.")

    st.write("ğŸ“ **Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ÙŠØ¯ÙˆÙŠÙ‹Ø§:**")
    user_input = st.text_input(
        "Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª:",
        key="input_coords",
        placeholder="30.727313, 31.284638 Ø£Ùˆ 30Â°43'12.1\"N 31Â°17'04.2\"E"
    )

    if st.button("ÙØ­Øµ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ±Ø³Ù… Ø§Ù„Ø®Ø±ÙŠØ·Ø©", type="primary", use_container_width=True):
        parsed = parse_latlon(user_input)
        if not parsed:
            st.warning("âŒ ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„.")
            st.session_state.search_result = None
        else:
            lat, lon = parsed

            # Ù†Ø·Ø§Ù‚ Ø§Ù„Ù‚ÙŠÙ…
            if not (-90 <= lat <= 90 and -180 <= lon <= 180):
                st.warning("âŒ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ØºÙŠØ± ØµØ­ÙŠØ­.")
                st.session_state.search_result = None
            else:
                point = Point(lon, lat)

                # âœ… ÙØ­Øµ Ø¨Ø¯ÙˆÙ† union: Ø¯Ø§Ø®Ù„ Ø£ÙŠ ÙˆØ§Ø­Ø¯ØŸ
                is_inside = (sub_poly.covers(point) or main_poly.covers(point))

                st.session_state.search_result = {"lat": lat, "lon": lon, "is_inside": is_inside}

# ---- (B) Ø§Ù„Ù†ØªÙŠØ¬Ø© + Ø§Ù„Ø®Ø±ÙŠØ·Ø© ----
with col2:
    st.subheader("ğŸ—ºï¸ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ù†ØªÙŠØ¬Ø©")

    if st.session_state.search_result is None:
        st.info("Ø£Ø¯Ø®Ù„ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… GPS Ø«Ù… Ø§Ø¶ØºØ· Ø²Ø± Ø§Ù„ÙØ­Øµ.")
    else:
        result = st.session_state.search_result
        lat = result["lat"]
        lon = result["lon"]
        is_inside = result["is_inside"]

        st.markdown("---")
        if is_inside:
            st.success("âœ… **Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ø§Ù„Ø£Ø±Ø¶ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­ÙŠØ² Ø§Ù„Ø¹Ù…Ø±Ø§Ù†ÙŠ.**")
        else:
            st.error("â›” **Ø§Ù„Ù†ØªÙŠØ¬Ø©: Ø§Ù„Ø£Ø±Ø¶ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø­ÙŠØ² Ø§Ù„Ø¹Ù…Ø±Ø§Ù†ÙŠ.**")

        st.info(f"Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„ØªÙŠ ØªÙ… ÙØ­ØµÙ‡Ø§: {lat}, {lon}")

        # Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        m = folium.Map(location=[lat, lon], zoom_start=17, control_scale=True)

        # Google Satellite
        folium.TileLayer(
            tiles="https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",
            attr="Google",
            name="Google Satellite",
            overlay=False,
            control=True
        ).add_to(m)

        folium.TileLayer("OpenStreetMap", name="OpenStreetMap", overlay=False, control=True).add_to(m)

        # Ø±Ø³Ù… Ø§Ù„Ù…Ø¶Ù„Ø¹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (Ø£ØµÙØ±)
        folium.Polygon(
            locations=MAIN_POINTS,
            color="yellow",
            weight=3,
            fill=True,
            fill_opacity=0.18,
            popup="Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø­ÙŠØ² Ø§Ù„Ø¹Ù…Ø±Ø§Ù†ÙŠ (Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)"
        ).add_to(m)

        # Ø±Ø³Ù… Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ù†ÙØµÙ„ (Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ)
        folium.Polygon(
            locations=SUB_POINTS,
            color="orange",
            weight=3,
            fill=True,
            fill_opacity=0.22,
            popup="Ø¬Ø²Ø¡ Ù…Ù†ÙØµÙ„ Ù…Ù† Ø§Ù„Ø­ÙŠØ² Ø§Ù„Ø¹Ù…Ø±Ø§Ù†ÙŠ"
        ).add_to(m)

        # Ø¯Ø¨ÙˆØ³ Ø§Ù„Ù…ÙˆÙ‚Ø¹
        folium.Marker(
            [lat, lon],
            popup="Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£Ø±Ø¶",
            icon=folium.Icon(color="green" if is_inside else "red", icon="info-sign")
        ).add_to(m)

        folium.LayerControl(collapsed=False).add_to(m)
        st_folium(m, width=None, height=560)
