import streamlit as st
from shapely.geometry import Point, Polygon
import folium
from streamlit_folium import st_folium
from streamlit_js_eval import get_geolocation
import re
import math # Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©

# --- 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© ---
st.set_page_config(page_title="Urban Cordon Checker", page_icon="ğŸŒ")
st.markdown("""<style>#MainMenu {visibility: hidden;} footer {visibility: hidden;} .stApp > header {display: none;}</style>""", unsafe_allow_html=True)

# --- 2. Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„Ø© (Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù€ 205 Ù…Ø±ØªØ¨Ø©) ---
raw_data_input = """
1 31Â° 17' 44.243" E 30Â° 43' 19.233" N
2 31Â° 17' 43.73" E 30Â° 43' 16.04" N
3 31Â° 17' 39.333" E 30Â° 43' 16.626" N
4 31Â° 17' 39.719" E 30Â° 43' 19.312" N
5 31Â° 18' 10.118" E 30Â° 43' 46.962" N
6 31Â° 18' 9.824" E 30Â° 43' 48.18" N
7 31Â° 18' 8.2" E 30Â° 43' 48.449" N
8 31Â° 18' 7.212" E 30Â° 43' 45.656" N
9 31Â° 18' 9.657" E 30Â° 43' 45.111" N
10 31Â° 18' 10.068" E 30Â° 43' 46.706" N
11 31Â° 18' 13.666" E 30Â° 43' 45.967" N
12 31Â° 18' 12.004" E 30Â° 43' 38.952" N
13 31Â° 18' 16.339" E 30Â° 43' 38.25" N
14 31Â° 18' 16.764" E 30Â° 43' 34.653" N
15 31Â° 18' 14.445" E 30Â° 43' 34.92" N
16 31Â° 18' 13.424" E 30Â° 43' 31.831" N
17 31Â° 18' 10.98" E 30Â° 43' 32.406" N
18 31Â° 18' 10.715" E 30Â° 43' 31.181" N
19 31Â° 18' 7.326" E 30Â° 43' 30.367" N
20 31Â° 18' 6.96" E 30Â° 43' 28.655" N
21 31Â° 18' 1.313" E 30Â° 43' 28.868" N
22 31Â° 18' 1.472" E 30Â° 43' 26.396" N
23 31Â° 17' 57.418" E 30Â° 43' 26.525" N
24 31Â° 17' 57.414" E 30Â° 43' 27.087" N
25 31Â° 17' 58.576" E 30Â° 43' 27.059" N
26 31Â° 17' 58.438" E 30Â° 43' 28.418" N
27 31Â° 17' 52.942" E 30Â° 43' 28.35" N
28 31Â° 17' 53.006" E 30Â° 43' 26.997" N
29 31Â° 17' 56.321" E 30Â° 43' 27.038" N
30 31Â° 17' 56.336" E 30Â° 43' 25.945" N
31 31Â° 17' 55.664" E 30Â° 43' 25.98" N
32 31Â° 17' 55.546" E 30Â° 43' 24.825" N
33 31Â° 17' 57.624" E 30Â° 43' 24.856" N
34 31Â° 17' 57.725" E 30Â° 43' 24.062" N
35 31Â° 17' 58.647" E 30Â° 43' 24.074" N
36 31Â° 17' 58.663" E 30Â° 43' 23.181" N
37 31Â° 17' 57.442" E 30Â° 43' 23.097" N
38 31Â° 17' 57.434" E 30Â° 43' 21.372" N
39 31Â° 17' 56.543" E 30Â° 43' 21.367" N
40 31Â° 17' 56.532" E 30Â° 43' 20.913" N
41 31Â° 17' 55.993" E 30Â° 43' 20.907" N
42 31Â° 17' 55.872" E 30Â° 43' 23.619" N
43 31Â° 17' 53.385" E 30Â° 43' 23.651" N
44 31Â° 17' 53.393" E 30Â° 43' 23.179" N
45 31Â° 17' 52.473" E 30Â° 43' 23.167" N
46 31Â° 17' 52.488" E 30Â° 43' 22.307" N
47 31Â° 17' 54.406" E 30Â° 43' 22.161" N
48 31Â° 17' 54.396" E 30Â° 43' 20.272" N
49 31Â° 17' 47.028" E 30Â° 43' 20.255" N
50 31Â° 17' 47.363" E 30Â° 43' 27.205" N
51 31Â° 17' 44.288" E 30Â° 43' 27.297" N
52 31Â° 17' 44.348" E 30Â° 43' 25.915" N
53 31Â° 17' 43.82" E 30Â° 43' 25.929" N
54 31Â° 17' 43.819" E 30Â° 43' 25.312" N
55 31Â° 17' 43.169" E 30Â° 43' 25.317" N
56 31Â° 17' 43.152" E 30Â° 43' 24.765" N
57 31Â° 17' 42.678" E 30Â° 43' 24.792" N
58 31Â° 17' 42.682" E 30Â° 43' 24.645" N
59 31Â° 17' 42.644" E 30Â° 43' 24.326" N
60 31Â° 17' 42.249" E 30Â° 43' 24.347" N
61 31Â° 17' 42.193" E 30Â° 43' 22.46" N
62 31Â° 17' 44.19" E 30Â° 43' 22.331" N
63 31Â° 17' 44.155" E 30Â° 43' 21.235" N
64 31Â° 17' 42.059" E 30Â° 43' 21.365" N
65 31Â° 17' 41.992" E 30Â° 43' 20.307" N
66 31Â° 17' 36.711" E 30Â° 43' 20.688" N
67 31Â° 17' 36.468" E 30Â° 43' 19.569" N
68 31Â° 17' 35.863" E 30Â° 43' 19.644" N
69 31Â° 17' 36.048" E 30Â° 43' 20.884" N
70 31Â° 17' 34.124" E 30Â° 43' 21.165" N
71 31Â° 17' 34.392" E 30Â° 43' 22.502" N
72 31Â° 17' 32.32" E 30Â° 43' 22.596" N
73 31Â° 17' 32.039" E 30Â° 43' 21.029" N
74 31Â° 17' 29.726" E 30Â° 43' 21.391" N
75 31Â° 17' 29.685" E 30Â° 43' 20.953" N
76 31Â° 17' 28.104" E 30Â° 43' 21.185" N
77 31Â° 17' 27.539" E 30Â° 43' 20.175" N
78 31Â° 17' 25.753" E 30Â° 43' 20.555" N
79 31Â° 17' 25.691" E 30Â° 43' 23.509" N
80 31Â° 17' 23.461" E 30Â° 43' 24.41" N
81 31Â° 17' 22.905" E 30Â° 43' 22.329" N
82 31Â° 17' 22.215" E 30Â° 43' 22.47" N
83 31Â° 17' 22.429" E 30Â° 43' 23.265" N
84 31Â° 17' 19.985" E 30Â° 43' 24.004" N
85 31Â° 17' 19.506" E 30Â° 43' 21.657" N
86 31Â° 17' 20.22" E 30Â° 43' 21.499" N
87 31Â° 17' 20.065" E 30Â° 43' 20.973" N
88 31Â° 17' 19.742" E 30Â° 43' 21.027" N
89 31Â° 17' 19.558" E 30Â° 43' 20.16" N
90 31Â° 17' 18.922" E 30Â° 43' 20.279" N
91 31Â° 17' 18.711" E 30Â° 43' 18.95" N
92 31Â° 17' 17.414" E 30Â° 43' 19.152" N
93 31Â° 17' 16.045" E 30Â° 43' 22.303" N
94 31Â° 17' 15.669" E 30Â° 43' 22.737" N
95 31Â° 17' 15.86" E 30Â° 43' 23.664" N
96 31Â° 17' 16.409" E 30Â° 43' 23.322" N
97 31Â° 17' 19.165" E 30Â° 43' 26.595" N
98 31Â° 17' 19.711" E 30Â° 43' 26.452" N
99 31Â° 17' 19.457" E 30Â° 43' 25.417" N
100 31Â° 17' 21.592" E 30Â° 43' 24.903" N
101 31Â° 17' 22.157" E 30Â° 43' 26.315" N
102 31Â° 17' 20.679" E 30Â° 43' 26.635" N
103 31Â° 17' 21.181" E 30Â° 43' 27.92" N
104 31Â° 17' 15.426" E 30Â° 43' 28.582" N
105 31Â° 17' 15.867" E 30Â° 43' 31.366" N
106 31Â° 17' 14.067" E 30Â° 43' 31.556" N
107 31Â° 17' 14.42" E 30Â° 43' 34.135" N
108 31Â° 17' 10.426" E 30Â° 43' 33.858" N
109 31Â° 17' 18.607" E 30Â° 43' 36.077" N
110 31Â° 17' 10.611" E 30Â° 43' 36.777" N
111 31Â° 17' 10.765" E 30Â° 43' 35.505" N
112 31Â° 17' 8.78" E 30Â° 43' 35.016" N
113 31Â° 17' 8.751" E 30Â° 43' 36.785" N
114 31Â° 17' 6.946" E 30Â° 43' 36.348" N
115 31Â° 17' 6.652" E 30Â° 43' 33.53" N
116 31Â° 17' 4.895" E 30Â° 43' 33.648" N
117 31Â° 17' 5.026" E 30Â° 43' 35.863" N
118 31Â° 16' 59.997" E 30Â° 43' 34.665" N
119 31Â° 17' 0.696" E 30Â° 43' 38.655" N
120 31Â° 16' 56.446" E 30Â° 43' 39.462" N
121 31Â° 16' 55.551" E 30Â° 43' 40.562" N
122 31Â° 16' 56.465" E 30Â° 43' 40.461" N
123 31Â° 16' 56.390" E 30Â° 43' 42.112" N
124 31Â° 16' 57.228" E 30Â° 43' 42.166" N
125 31Â° 16' 57.214" E 30Â° 43' 42.718" N
126 31Â° 16' 58.249" E 30Â° 43' 42.777" N
127 31Â° 16' 58.288" E 30Â° 43' 43.577" N
128 31Â° 17' 0.138" E 30Â° 43' 43.619" N
129 31Â° 17' 0.132" E 30Â° 43' 43.92" N
130 31Â° 17' 2.183" E 30Â° 43' 44.018" N
131 31Â° 17' 2.106" E 30Â° 43' 45.73" N
132 31Â° 17' 3.476" E 30Â° 43' 45.799" N
133 31Â° 17' 3.437" E 30Â° 43' 46.665" N
134 31Â° 17' 7.896" E 30Â° 43' 48.534" N
135 31Â° 17' 7.816" E 30Â° 43' 50.261" N
136 31Â° 17' 9.87" E 30Â° 43' 50.211" N
137 31Â° 17' 9.795" E 30Â° 43' 51.91" N
138 31Â° 17' 12.251" E 30Â° 43' 51.897" N
139 31Â° 17' 12.229" E 30Â° 43' 54.148" N
140 31Â° 17' 14.755" E 30Â° 43' 54.186" N
141 31Â° 17' 14.706" E 30Â° 43' 54.976" N
142 31Â° 17' 10.413" E 30Â° 43' 55.84" N
143 31Â° 17' 10.651" E 30Â° 43' 58.124" N
144 31Â° 17' 12.15" E 30Â° 43' 57.966" N
145 31Â° 17' 12.322" E 30Â° 43' 58.865" N
146 31Â° 17' 10.121" E 30Â° 43' 59.157" N
147 31Â° 17' 10.412" E 30Â° 44' 0.455" N
148 31Â° 17' 13.622" E 30Â° 43' 59.953" N
149 31Â° 17' 14.167" E 30Â° 44' 2.089" N
150 31Â° 17' 12.137" E 30Â° 44' 2.369" N
151 31Â° 17' 12.439" E 30Â° 44' 3.741" N
152 31Â° 17' 13.314" E 30Â° 44' 3.604" N
153 31Â° 17' 13.893" E 30Â° 44' 6.858" N
154 31Â° 17' 15.77" E 30Â° 44' 6.587" N
155 31Â° 17' 16.105" E 30Â° 44' 7.854" N
156 31Â° 17' 16.779" E 30Â° 44' 7.745" N
157 31Â° 17' 16.937" E 30Â° 44' 8.455" N
158 31Â° 17' 19.877" E 30Â° 44' 9.616" N
159 31Â° 17' 20.266" E 30Â° 44' 8.761" N
160 31Â° 17' 24.221" E 30Â° 44' 10.005" N
161 31Â° 17' 26.184" E 30Â° 44' 10.323" N
162 31Â° 17' 25.91" E 30Â° 44' 11.8" N
163 31Â° 17' 31.47" E 30Â° 44' 12.185" N
164 31Â° 17' 31.549" E 30Â° 44' 15.013" N
165 31Â° 17' 34.851" E 30Â° 44' 14.492" N
166 31Â° 17' 35.819" E 30Â° 44' 16.282" N
167 31Â° 17' 39.271" E 30Â° 44' 16.033" N
168 31Â° 17' 39.013" E 30Â° 44' 14.59" N
169 31Â° 17' 43.909" E 30Â° 44' 13.039" N
170 31Â° 17' 43.376" E 30Â° 44' 11.645" N
171 31Â° 17' 48.208" E 30Â° 44' 10.268" N
172 31Â° 17' 47.962" E 30Â° 44' 9.442" N
173 31Â° 17' 51.127" E 30Â° 44' 8.396" N
174 31Â° 17' 51.388" E 30Â° 44' 8.831" N
175 31Â° 17' 51.725" E 30Â° 44' 8.713" N
176 31Â° 17' 52.779" E 30Â° 44' 10.439" N
177 31Â° 18' 1.284" E 30Â° 44' 7.072" N
178 31Â° 18' 1.976" E 30Â° 44' 6.47" N
179 31Â° 18' 3.449" E 30Â° 44' 8.017" N
180 31Â° 18' 4.015" E 30Â° 44' 9.493" N
181 31Â° 18' 7.781" E 30Â° 44' 8.467" N
182 31Â° 18' 7.971" E 30Â° 44' 9.397" N
183 31Â° 18' 9.658" E 30Â° 44' 8.943" N
184 31Â° 18' 6.256" E 30Â° 44' 7.711" N
185 31Â° 18' 4.538" E 30Â° 44' 4.196" N
186 31Â° 18' 10.449" E 30Â° 44' 2.428" N
187 31Â° 18' 11.286" E 30Â° 44' 4.064" N
188 31Â° 18' 13.222" E 30Â° 44' 3.402" N
189 31Â° 18' 12.606" E 30Â° 44' 2.917" N
190 31Â° 18' 11.573" E 30Â° 44' 2.707" N
191 31Â° 18' 10.214" E 30Â° 43' 59.97" N
192 31Â° 18' 11.107" E 30Â° 43' 59.622" N
193 31Â° 18' 10.944" E 30Â° 43' 59.245" N
194 31Â° 18' 14.631" E 30Â° 43' 58.286" N
195 31Â° 18' 13.655" E 30Â° 43' 56.663" N
196 31Â° 18' 17.652" E 30Â° 43' 56.464" N
197 31Â° 18' 17.277" E 30Â° 43' 54.509" N
198 31Â° 18' 16.138" E 30Â° 43' 54.877" N
199 31Â° 18' 14.824" E 30Â° 43' 51.63" N
200 31Â° 18' 15.412" E 30Â° 43' 51.649" N
201 31Â° 18' 16.269" E 30Â° 43' 51.179" N
202 31Â° 18' 13.902" E 30Â° 43' 51.557" N
203 31Â° 18' 12.483" E 30Â° 43' 47.603" N
204 31Â° 18' 11.645" E 30Â° 43' 47.78" N
205 31Â° 18' 11.836" E 30Â° 43' 45.656" N
"""

# --- 3. Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø°ÙƒÙŠØ© (Smart Split Ø¨Ø¯ÙˆÙ† geopy) ---
def parse_coordinates(raw_text):
    """ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª (Lat, Lon) Ø¯Ù‚ÙŠÙ‚Ø©"""
    points = []
    lines = raw_text.strip().split('\n')
    for line in lines:
        try:
            dms_match = re.findall(r"(\d+)[Â°](\d+)['](\d+\.?\d*)[\"]\s*([NSEW])", line)
            if len(dms_match) >= 2:
                coords = []
                for part in dms_match:
                    deg, mn, sec, direction = float(part[0]), float(part[1]), float(part[2]), part[3]
                    val = deg + (mn/60) + (sec/3600)
                    if direction in ['S', 'W']: val = -val
                    coords.append(val)
                if abs(coords[0] - 30) < abs(coords[1] - 30):
                    points.append((coords[0], coords[1]))
                else:
                    points.append((coords[1], coords[0]))
                continue
        except: continue
    return points

def haversine_distance(coord1, coord2):
    """Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ù†Ù‚Ø·ØªÙŠÙ† Ø¨Ø§Ù„Ù…ØªØ± (Ø¨Ø¯ÙŠÙ„ Ù…ÙƒØªØ¨Ø© geopy)"""
    R = 6371000 # Ù†ØµÙ Ù‚Ø·Ø± Ø§Ù„Ø£Ø±Ø¶ Ø¨Ø§Ù„Ù…ØªØ±
    lat1, lon1 = math.radians(coord1[0]), math.radians(coord1[1])
    lat2, lon2 = math.radians(coord2[0]), math.radians(coord2[1])
    
    dlat = lat2 - lat1
    dlon = lon2 - lon1
    
    a = math.sin(dlat / 2)**2 + math.cos(lat1) * math.cos(lat2) * math.sin(dlon / 2)**2
    c = 2 * math.atan2(math.sqrt(a), math.sqrt(1 - a))
    
    return R * c

def smart_split_polygons(points, gap_threshold_meters=60):
    """Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ù„ÙØµÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©"""
    if not points: return []
    
    polygons = []
    current_poly_points = [points[0]]
    
    for i in range(1, len(points)):
        prev_p = points[i-1]
        curr_p = points[i]
        
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ© Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©
        dist = haversine_distance(prev_p, curr_p)
        
        if dist > gap_threshold_meters:
            if len(current_poly_points) > 2:
                polygons.append(current_poly_points)
            current_poly_points = [curr_p]
        else:
            current_poly_points.append(curr_p)
            
    if len(current_poly_points) > 2:
        polygons.append(current_poly_points)
        
    return polygons

# --- 4. Ø§Ù„ØªÙ†ÙÙŠØ° ÙˆØ§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ---
all_points = parse_coordinates(raw_data_input)
shape_groups = smart_split_polygons(all_points, gap_threshold_meters=60)

shapely_polys = []
for grp in shape_groups:
    if grp[0] != grp[-1]: grp.append(grp[0])
    poly_coords = [(lon, lat) for lat, lon in grp]
    shapely_polys.append(Polygon(poly_coords))

# --- 5. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
st.title("ğŸŒ ÙƒØ´Ù Ø§Ù„Ø­ÙŠØ² Ø§Ù„Ø¹Ù…Ø±Ø§Ù†ÙŠ (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©)")
st.markdown("""<div style="direction: rtl; text-align: center; border: 2px solid #FF4B4B; padding: 10px; border-radius: 10px; margin-bottom: 15px;">ğŸ“ Ø§Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ù„Ù„ÙØ­Øµ</div>""", unsafe_allow_html=True)

col1, col2 = st.columns([1, 3])
with col1:
    if st.button("ğŸ“ Ù…ÙˆÙ‚Ø¹ÙŠ"):
        try:
            loc = get_geolocation(component_key='get_loc')
            if loc: st.session_state.input_coords = f"{loc['coords']['latitude']}, {loc['coords']['longitude']}"
        except: pass
with col2:
    user_input = st.text_input("", key='input_coords', placeholder="30.7xxxx, 31.2xxxx", label_visibility="collapsed")

if all_points:
    center_lat = all_points[0][0]
    center_lon = all_points[0][1]
    m = folium.Map(location=[center_lat, center_lon], zoom_start=15)
    folium.TileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', attr='Google', name='Satellite').add_to(m)

    for grp in shape_groups:
        folium.Polygon(
            locations=grp,
            color="#FFFF00", 
            weight=2,
            fill=True,
            fill_opacity=0.1,
            popup="Ø­ÙŠØ² Ø¹Ù…Ø±Ø§Ù†ÙŠ"
        ).add_to(m)

    if user_input:
        try:
            parts = user_input.replace(',', ' ').split()
            lat, lon = float(parts[0]), float(parts[1])
            user_point = Point(lon, lat)
            is_inside = any(poly.contains(user_point) for poly in shapely_polys)
            
            icon = "green" if is_inside else "red"
            msg = "âœ… Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­ÙŠØ²" if is_inside else "â›” Ø®Ø§Ø±Ø¬ Ø§Ù„Ø­ÙŠØ²"
            st.markdown(f"### {msg}")
            folium.Marker([lat, lon], icon=folium.Icon(color=icon), popup=msg).add_to(m)
        except: st.warning("ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø£Ø±Ù‚Ø§Ù…")

    st_folium(m, width=700, height=500)
else:
    st.error("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª")
    
